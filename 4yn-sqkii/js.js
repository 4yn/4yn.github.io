function handleClicks(t){showCoords&&$("#show-coords").append(t.latLng+",\r\n"),null!=clickCallback&&clickCallback(t),clickCallback=null}function initMap(){(map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:1.3521,lng:103.8198},mapTypeId:"roadmap"})).addListener("click",function(t){handleClicks(t)}),gpsMarker=new google.maps.Marker({position:gpsCoord,icon:gpsIcon,map:null}),(new google.maps.TransitLayer).setMap(map),showHints(),storage=window.localStorage,$("#data_import").val(storage.getItem("sqkii-json")),window.setTimeout(function(){null!=$("#data_import").val()?parseHints():loadDefaultMap()},1e3)}function parseHints(){for(var t in currentShapes)for(var e in currentShapes[t])shape=currentShapes[t][e],shape.setMap(null);currentShapes=[],currentHints=JSON.parse($("#data_import").val()),storage.setItem("sqkii-json",$("#data_import").val()),$("#hint-wrapper").html("");for(var t in currentHints){var a=currentHints[t];currentShapesVisibility[t]=!0;for(var e in a.mapShapes){var i=a.mapShapes[e];null==currentShapes[t]&&(currentShapes[t]=[]),currentShapes[t].push(drawHint(a.mapImpact,i,!1))}var n=$("<div></div>").addClass("hint").attr("id","hint-"+t),r=$("<span></span>").addClass("hint-header");r.append('<h4 onClick="hintRadio('+t+');">'+a.name+"</h4>");var s=$("<span></span>").addClass("hint-body");s.html("<h5>"+a.hintText+"</h5>"+a.hintInterpret);var o=$("<div></div>").addClass("hint-toolbar");o.append($("<i></i>").addClass("fa fa-eye fa-2x").attr("id","hint-"+t+"-visibility").attr("onClick","toggleHint("+t+");")),1==a.mapImpact?o.append($("<i></i>").addClass("fa fa-circle fa-2x cgood").attr("id","hint-"+t+"-impact")):o.append($("<i></i>").addClass("fa fa-circle fa-2x cbad").attr("id","hint-"+t+"-impact")),""!=a.hintPL&&o.append($("<a></a>").attr("href",a.hintPL).attr("target","_blank").append($("<i></i>").addClass("fa fa-link fa-2x cinfo").attr("id","hint-"+t+"-link"))),o.append($("<i></i>").addClass("fa fa-edit fa-2x").attr("id","hint-"+t+"-edit").attr("onClick","beginEdit("+t+");")),o.append($("<i></i>").addClass("fa fa-trash fa-2x").attr("id","hint-"+t+"-trash").attr("onClick","deleteHint("+t+");")),n.append(r).append(s).append(o),$("#hint-wrapper").append(n)}}function saveAndReloadHints(){$("#data_import").val(JSON.stringify(currentHints)),parseHints()}function drawHint(t,e,a){if(null==a&&(a=!1),"circle"==e.type)return(d=new google.maps.Circle({strokeColor:options.borderColors[t],strokeOpacity:.4,strokeWeight:2,fillColor:options.shapeColors[t],fillOpacity:.1,map:map,center:{lat:e.coords[0],lng:e.coords[1]},radius:e.radius,editable:a,draggable:a})).addListener("click",function(t){handleClicks(t)}),d;if("polygon"==e.type){o=[];for(var i in e.coords)o.push({lat:e.coords[i][0],lng:e.coords[i][1]});return d=new google.maps.Polygon({paths:o,strokeColor:options.borderColors[t],strokeOpacity:1,strokeWeight:3,fillColor:options.shapeColors[t],fillOpacity:.3,map:map,editable:a,draggable:a})}if("polygon-multi"==e.type){var n=[];for(var r in e.coords){var s=e.coords[r];0!=r&&s.reverse();var o=[];for(var i in s)o.push({lat:s[i][0],lng:s[i][1]});n.push(o)}var d=new google.maps.Polygon({paths:n,strokeColor:options.borderColors[t],strokeOpacity:1,strokeWeight:3,fillColor:options.shapeColors[t],fillOpacity:.3,map:map,editable:a,draggable:a});return d}}function reloadShape(t,e,a){currentShapes[t][e].setMap(null),currentShapes[t][e]=null;var i=drawHint(currentHints[t].mapImpact,currentHints[t].mapShapes[e],a);currentShapes[t][e]=i}function toggleHint(t){if(1==currentShapesVisibility[t]){currentShapesVisibility[t]=!1;e=null;$("#hint-"+t+"-visibility").removeClass("fa-eye"),$("#hint-"+t+"-visibility").addClass("fa-eye-slash")}else{currentShapesVisibility[t]=!0;var e=map;$("#hint-"+t+"-visibility").removeClass("fa-eye-slash"),$("#hint-"+t+"-visibility").addClass("fa-eye")}for(var a in currentShapes[t])currentShapes[t][a].setMap(e)}function toggleShowCoords(){showCoords=!showCoords,$("#toggle-coords").toggleClass("disabled"),0==showCoords&&$("#show-coords").html("")}function toggleGPS(){showGPS=!showGPS,$("#toggle-gps").toggleClass("disabled"),runningGPS||updateGPS()}function updateGPS(){navigator.geolocation?(runningGPS||(runningGPS=!0,gpsMarker.setMap(map)),navigator.geolocation.getCurrentPosition(drawGPS),showGPS?window.setTimeout(updateGPS,1e3):(runningGPS=!1,gpsMarker.setMap(null))):(runningGPS=!1,gpsMarker.setMap(null))}function drawGPS(t){gpsCoord.lat=t.coords.latitude,gpsCoord.lng=t.coords.longitude,gpsIcon.rotation=t.coords.heading,gpsMarker.setPosition(gpsCoord)}function loadDefaultMap(){$.getJSON("./data.json",function(t){currentHints=t}),saveAndReloadHints()}function loadBlankMap(){currentHints=[],saveAndReloadHints()}function showHints(){$("#show-hints").removeClass("disabled"),$("#show-dev").addClass("disabled"),$("#hint-wrapper").show(),$("#dev-wrapper").hide()}function showDev(){hintRadio(-1),$("#show-hints").addClass("disabled"),$("#show-dev").removeClass("disabled"),$("#hint-wrapper").hide(),$("#dev-wrapper").show()}function newHint(){currentHints.push({name:"New Hint",hintPL:"",hintText:"",hintInterpret:"",mapImpact:!1,mapShapes:[]}),saveAndReloadHints()}function toggleSidebar(){(showSidebar=!showSidebar)?($("#sidebar").css("margin-left","0px"),$("#sidebar-toggle").html("hide me")):($("#sidebar").css("margin-left","-400px"),$("#sidebar-toggle").html("show me"))}function hintRadio(t){focusedHint!=t?(-1!=focusedHint&&($("#hint-"+focusedHint).removeClass("focus"),$("#hint-"+focusedHint+" .hint-body").slideToggle(300)),$("#hint-"+t).addClass("focus"),$("#hint-"+t+" .hint-body").slideToggle(300),focusedHint=t):($("#hint-"+t).removeClass("focus"),$("#hint-"+t+" .hint-body").slideToggle(300),focusedHint=-1)}function deleteHint(t){confirm("are you sure?")&&(currentHints.splice(t,1),saveAndReloadHints())}function beginEdit(t){toggleSidebar(),$("#edit-drawer").css("margin-left","0px"),$("#edit-done-wrapper").css("margin-left","400px"),currentlyEditing=currentHints[t],currentlyEditingGroup=t,$("#edit-hint-title").val(currentlyEditing.name),$("#edit-hint-text").val(currentlyEditing.hintText),$("#edit-hint-permalink").val(currentlyEditing.hintPL),$("#edit-hint-interpret").val(currentlyEditing.hintInterpret),$("#edit-impact-type").data("impact",currentlyEditing.mapImpact),1==$("#edit-impact-type").data("impact")?$("#edit-impact-type").addClass("cgood").removeClass("cbad"):$("#edit-impact-type").removeClass("cgood").addClass("cbad"),$("#edit-hint-wrapper").html("");for(var e in currentlyEditing.mapShapes){var a=currentlyEditing.mapShapes[e],i=$("<div></div>").addClass("edit-shape");i.append($("<span></span>").append(a.type).addClass("edit-shape-header")),"circle"==a.type?(i.append($("<span></span>").addClass("button cinfo").append("Recenter").attr("onClick","editUpdateCenter("+e+")")),i.append($("<input type='number' style='width:100px'>").attr("id","edit-shape-"+e+"-radius").attr("onChange","editUpdateRadius("+e+")").val(a.radius))):"polygon"==a.type&&i.append($("<span></span>").addClass("button cinfo").append("Edit").attr("onClick","editChangeBorder("+e+")")),i.append($("<span></span>").addClass("button cbad").append("Delete").attr("onClick","editDelete("+e+")")),$("#edit-hint-wrapper").append($("</br>")).append(i)}}function finishEdit(t){toggleSidebar(),$("#edit-drawer").css("margin-left","-400px"),$("#edit-done-wrapper").css("margin-left","20px"),currentlyEditing.name=$("#edit-hint-title").val(),currentlyEditing.hintText=$("#edit-hint-text").val(),currentlyEditing.hintPL=$("#edit-hint-permalink").val(),currentlyEditing.hintInterpret=$("#edit-hint-interpret").val(),clickCallback=null;for(var e in currentShapes[currentlyEditingGroup]){var a=currentShapes[currentlyEditingGroup][e];if(a.editable){var i=a.getPath().b;currentHints[currentlyEditingGroup].mapShapes[e].coords=[];for(var n in i)currentHints[currentlyEditingGroup].mapShapes[e].coords.push([i[n].lat(),i[n].lng()])}}saveAndReloadHints()}function editToggleImpact(){$("#edit-impact-type").data("impact",!$("#edit-impact-type").data("impact")),currentlyEditing.mapImpact=$("#edit-impact-type").data("impact"),1==$("#edit-impact-type").data("impact")?$("#edit-impact-type").addClass("cgood").removeClass("cbad"):$("#edit-impact-type").removeClass("cgood").addClass("cbad");for(var t in currentlyEditing.mapShapes)reloadShape(currentlyEditingGroup,t)}function editUpdateRadius(t){var e=parseInt($("#edit-shape-"+t+"-radius").val());currentlyEditing.mapShapes[t].radius=e,reloadShape(currentlyEditingGroup,t)}function editUpdateCenter(t){clickCallback=function(e){currentlyEditing.mapShapes[t].coords[0]=e.latLng.lat(),currentlyEditing.mapShapes[t].coords[1]=e.latLng.lng(),reloadShape(currentlyEditingGroup,t)}}function editChangeBorder(t){reloadShape(currentlyEditingGroup,t,!0)}function editAddCircle(){currentlyEditing.mapShapes.push({type:"circle",radius:1e3,coords:[1.3521,103.8198]});var t=parseInt(currentlyEditingGroup);finishEdit(t),beginEdit(t)}function editAddPolygon(){currentlyEditing.mapShapes.push({type:"polygon",coords:[[1.3654369889022704,103.80372047424316],[1.3515363255670068,103.80638122558594],[1.3585724737941975,103.82178783416748]]});var t=parseInt(currentlyEditingGroup);finishEdit(t),beginEdit(t)}function editDelete(t){var e=parseInt(currentlyEditingGroup);currentlyEditing.mapShapes.splice(t,1),finishEdit(e),beginEdit(e)}function faqToggle(){$(".faq").slideToggle(300)}var map,gpsIcon={path:"M -7,7 0,0 7,7",strokeColor:"#007991",strokeWeight:4,rotation:0},gpsMarker,gpsCoord={lat:0,lng:0},storage,options={shapeColors:{true:"#06D6A0",false:"#D64550"},borderColors:{true:"#06D6A0",false:"#D64550"}},clickCallback,currentHints,currentShapes=[],currentShapesVisibility=[],showCoords=!1,showGPS=!1,runningGPS=!1,showSidebar=!0,focusedHint=-1,curentlyEditing=null,currentlyEditingGroup=null;